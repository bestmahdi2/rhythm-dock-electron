# .github/workflows/release.yml

name: Create Release and Build

# This workflow runs when you push a tag that starts with 'v' (e.g., v1.0.1, v1.2.0)
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # This job creates a draft release on GitHub
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.release_creator.outputs.upload_url }}
    steps:
      - name: Create Draft Release
        id: release_creator
        uses: ncipollo/release-action@v1
        with:
          # This token is provided by GitHub automatically
          token: ${{ secrets.GITHUB_TOKEN }}
          # Use the tag name for the release title
          name: Release ${{ github.ref_name }}
          # Mark the release as a draft so you can review it before publishing
          draft: true
          prerelease: false

  # This job builds the app on multiple operating systems
  build-and-upload:
    name: Build and Upload Artifacts
    needs: create-release
    strategy:
      matrix:
        os: [ windows-latest ] #, macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install
        working-directory: './Rhythm Dock'

      - name: Build Application
        run: npm run dist -- --win --x64 --ia32
        working-directory: './Rhythm Dock'

      # --- NEW DEBUGGING STEP ---
      # This will show us exactly what files are in the output directory.
      - name: List Build Artifacts
        run: ls -R
        working-directory: './Rhythm Dock/dist'

      - name: Upload Release Asset
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          # FIX: Simplified the path to be more direct for Windows builds.
          asset_path: './Rhythm Dock/dist/*.exe'
          allowUpdates: true